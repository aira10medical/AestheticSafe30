<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AIRA Assistant</title>

  <style>
    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 0;
      padding-bottom: 100px;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
      background: #ffffff;
    }

    /* ---------- Fixed Chat Container (Bottom) ---------- */
    #aira-chat-container {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: #ffffff;
      border-top: 1px solid #e5e5e5;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.08);
      z-index: 9999;
    }

    /* ---------- Messages Area (Optional scrollable history) ---------- */
    #messages {
      max-height: 300px;
      overflow-y: auto;
      padding: 16px 20px;
      background: #f9f9f9;
      display: none;
    }

    #messages.visible {
      display: block;
    }

    #messages::-webkit-scrollbar {
      width: 6px;
    }

    #messages::-webkit-scrollbar-thumb {
      background: #d1d5db;
      border-radius: 3px;
    }

    .msg-user {
      text-align: right;
      margin: 10px 0;
    }

    .msg-user span {
      display: inline-block;
      background: #10a37f;
      color: white;
      padding: 10px 14px;
      border-radius: 16px;
      border-bottom-right-radius: 4px;
      max-width: 70%;
      font-size: 14px;
      line-height: 1.5;
      word-wrap: break-word;
    }

    .msg-bot {
      text-align: left;
      margin: 10px 0;
    }

    .msg-bot span {
      display: inline-block;
      background: #ffffff;
      color: #2d333a;
      padding: 10px 14px;
      border-radius: 16px;
      border-bottom-left-radius: 4px;
      max-width: 70%;
      font-size: 14px;
      line-height: 1.5;
      word-wrap: break-word;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    /* ---------- Input Area (ChatGPT exact style) ---------- */
    #input-area {
      display: flex;
      align-items: center;
      padding: 16px 20px;
      background: #ffffff;
      gap: 10px;
      max-width: 900px;
      margin: 0 auto;
    }

    #attach-btn {
      width: 36px;
      height: 36px;
      border: none;
      background: transparent;
      cursor: pointer;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background .2s;
      flex-shrink: 0;
    }

    #attach-btn:hover {
      background: #f4f4f4;
    }

    #attach-btn svg {
      width: 20px;
      height: 20px;
      fill: #6b6b7b;
    }

    #file-input {
      display: none;
    }

    #input-wrapper {
      flex: 1;
      position: relative;
      display: flex;
      align-items: center;
      background: #ffffff;
      border: 1px solid #d1d1d6;
      border-radius: 28px;
      padding: 0 20px;
      transition: all .2s;
    }

    #input-wrapper:focus-within {
      border-color: #a6a6aa;
      box-shadow: 0 0 0 3px rgba(16, 163, 127, 0.1);
    }

    #user-text {
      flex: 1;
      padding: 14px 0;
      border: none;
      background: transparent;
      font-size: 15px;
      color: #1f1f1f;
      outline: none;
      font-family: inherit;
    }

    #user-text::placeholder {
      color: #86868b;
    }

    .input-icons {
      display: flex;
      align-items: center;
      gap: 4px;
      margin-left: 8px;
    }

    .input-icon-btn {
      width: 32px;
      height: 32px;
      border: none;
      background: transparent;
      cursor: pointer;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background .2s;
      flex-shrink: 0;
    }

    .input-icon-btn:hover {
      background: #f4f4f4;
    }

    .input-icon-btn svg {
      width: 20px;
      height: 20px;
      fill: #6b6b7b;
    }

    #send-btn {
      width: 32px;
      height: 32px;
      border: none;
      background: transparent;
      color: #6b6b7b;
      border-radius: 6px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all .2s;
      flex-shrink: 0;
    }

    #send-btn:hover {
      background: #f4f4f4;
    }

    #send-btn:active {
      transform: scale(0.95);
    }

    #send-btn svg {
      width: 20px;
      height: 20px;
      fill: #6b6b7b;
    }

    #send-btn.active {
      background: #10a37f;
    }

    #send-btn.active svg {
      fill: white;
    }

    #send-btn.active:hover {
      background: #0c8a6a;
    }

    #send-btn:disabled {
      background: transparent;
      cursor: not-allowed;
      opacity: 0.5;
    }

    .file-preview {
      position: absolute;
      bottom: 100%;
      left: 20px;
      background: #f4f4f4;
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 13px;
      color: #2d333a;
      margin-bottom: 8px;
      display: none;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .file-preview.visible {
      display: block;
    }

    .file-preview-close {
      margin-left: 12px;
      cursor: pointer;
      color: #6b6b7b;
      font-weight: bold;
    }

    /* Toggle messages button */
    #toggle-messages-btn {
      position: absolute;
      top: -40px;
      right: 20px;
      background: #f4f4f4;
      color: #6b6b7b;
      border: 1px solid #e5e5e5;
      padding: 8px 16px;
      border-radius: 20px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      transition: all .2s;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    }

    #toggle-messages-btn:hover {
      background: #e8e8e8;
      color: #2d333a;
      transform: translateY(-2px);
    }

    /* Responsive */
    @media (max-width: 768px) {
      #input-area {
        padding: 12px 16px;
        gap: 8px;
      }

      #input-wrapper {
        padding: 0 16px;
      }

      #user-text {
        padding: 12px 0;
        font-size: 16px;
      }

      #messages {
        max-height: 250px;
      }
    }
  </style>
</head>

<body>

  <!-- Fixed Chat Container at Bottom -->
  <div id="aira-chat-container">
    <button id="toggle-messages-btn">Historial â–²</button>
    
    <div id="messages"></div>

    <div id="input-area">
      <button id="attach-btn" title="Adjuntar archivo (imagen o DICOM)">
        <svg viewBox="0 0 24 24">
          <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
        </svg>
      </button>
      
      <input type="file" id="file-input" accept="image/*,.dcm" />
      
      <div class="file-preview" id="file-preview"></div>
      
      <div id="input-wrapper">
        <input id="user-text" placeholder="Pregunta lo que quieras" autocomplete="off" />
        
        <div class="input-icons">
          <button class="input-icon-btn" id="mic-btn" title="MicrÃ³fono">
            <svg viewBox="0 0 24 24">
              <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.91-3c-.49 0-.9.36-.98.85C16.52 14.2 14.47 16 12 16s-4.52-1.8-4.93-4.15c-.08-.49-.49-.85-.98-.85-.61 0-1.09.54-1 1.14.49 3 2.89 5.35 5.91 5.78V20c0 .55.45 1 1 1s1-.45 1-1v-2.08c3.02-.43 5.42-2.78 5.91-5.78.1-.6-.39-1.14-1-1.14z"/>
            </svg>
          </button>
          
          <button class="input-icon-btn" id="audio-btn" title="Audio avanzado">
            <svg viewBox="0 0 24 24">
              <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/>
            </svg>
          </button>
        </div>
      </div>
      
      <button id="send-btn">
        <svg viewBox="0 0 24 24">
          <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
        </svg>
      </button>
    </div>
  </div>

  <script>
    const apiURL = "https://aira-backend-api-production.up.railway.app/ask";

    const messages = document.getElementById("messages");
    const sendBtn = document.getElementById("send-btn");
    const input = document.getElementById("user-text");
    const attachBtn = document.getElementById("attach-btn");
    const fileInput = document.getElementById("file-input");
    const filePreview = document.getElementById("file-preview");
    const toggleMessagesBtn = document.getElementById("toggle-messages-btn");

    let currentFileBase64 = null;
    let currentFileName = null;
    let messagesVisible = false;

    // Toggle messages history
    toggleMessagesBtn.onclick = () => {
      messagesVisible = !messagesVisible;
      if (messagesVisible) {
        messages.classList.add('visible');
        toggleMessagesBtn.textContent = 'Historial â–¼';
      } else {
        messages.classList.remove('visible');
        toggleMessagesBtn.textContent = 'Historial â–²';
      }
    };

    // Attach file button
    attachBtn.onclick = () => fileInput.click();

    // Handle file selection
    fileInput.onchange = (e) => {
      const file = e.target.files[0];
      if (!file) return;

      currentFileName = file.name;
      
      const reader = new FileReader();
      reader.onload = (event) => {
        currentFileBase64 = event.target.result.split(',')[1];
        filePreview.innerHTML = `ðŸ“Ž ${currentFileName} <span class="file-preview-close" onclick="clearFile()">âœ•</span>`;
        filePreview.classList.add('visible');
      };
      reader.readAsDataURL(file);
    };

    // Clear file
    window.clearFile = () => {
      currentFileBase64 = null;
      currentFileName = null;
      filePreview.classList.remove('visible');
      fileInput.value = "";
    };

    // Send message (with optional file)
    async function sendMessage() {
      const text = input.value.trim();
      if (!text && !currentFileBase64) return;

      sendBtn.disabled = true;

      const userMsg = text || `[Archivo: ${currentFileName}]`;
      
      // Show messages if first message
      if (!messagesVisible && messages.children.length === 0) {
        messagesVisible = true;
        messages.classList.add('visible');
        toggleMessagesBtn.textContent = 'Historial â–¼';
      }

      messages.innerHTML += `<div class="msg-user"><span>${userMsg}</span></div>`;
      input.value = "";

      const payload = { message: text };
      
      if (currentFileBase64) {
        payload.file = currentFileBase64;
        payload.filename = currentFileName;
      }

      try {
        const res = await fetch(apiURL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        const data = await res.json();
        messages.innerHTML += `<div class="msg-bot"><span>${data.reply || 'Error en la respuesta'}</span></div>`;
      } catch (error) {
        messages.innerHTML += `<div class="msg-bot"><span>Error: No se pudo conectar con AIRA</span></div>`;
      }

      messages.scrollTop = messages.scrollHeight;
      
      clearFile();
      sendBtn.disabled = false;
      sendBtn.classList.remove('active');
      input.focus();
    }

    sendBtn.onclick = sendMessage;

    input.onkeypress = (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        sendMessage();
      }
    };

    // Update send button style based on input
    input.oninput = () => {
      if (input.value.trim().length > 0) {
        sendBtn.classList.add('active');
      } else {
        sendBtn.classList.remove('active');
      }
    };

    // Mic and audio buttons (placeholders for future functionality)
    const micBtn = document.getElementById("mic-btn");
    const audioBtn = document.getElementById("audio-btn");

    micBtn.onclick = () => {
      console.log("MicrÃ³fono clicked - placeholder para funcionalidad futura");
    };

    audioBtn.onclick = () => {
      console.log("Audio avanzado clicked - placeholder para funcionalidad futura");
    };

    // Focus input on load
    window.onload = () => input.focus();
  </script>

</body>
</html>
